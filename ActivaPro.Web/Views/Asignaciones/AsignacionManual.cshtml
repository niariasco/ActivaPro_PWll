@{
    ViewData["Title"] = "Asignación Manual de Tickets";
    var ticketsPendientes = ViewBag.TicketsPendientes as List<ActivaPro.Application.DTOs.TicketPendienteAsignacionDTO> ?? new List<ActivaPro.Application.DTOs.TicketPendienteAsignacionDTO>();
    var tecnicosDisponibles = ViewBag.TecnicosDisponibles as List<ActivaPro.Application.DTOs.TecnicoDisponibleDTO> ?? new List<ActivaPro.Application.DTOs.TecnicoDisponibleDTO>();
    var esTicketEspecifico = ViewBag.TicketEspecifico as bool? ?? false;
    var ticketId = ViewBag.TicketId as int? ?? 0;
}

<div class="container-fluid py-4">
    <!-- HEADER -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="bi bi-person-fill-gear text-success"></i>
                        @if (esTicketEspecifico)
                        {
                            <text>Asignar Ticket #@ticketId</text>
                        }
                        else
                        {
                            <text>Asignación Manual de Tickets</text>
                        }
                    </h2>
                    <p class="text-muted mb-0">
                        @if (esTicketEspecifico)
                        {
                            <text>Seleccione el técnico más adecuado para este ticket</text>
                        }
                        else
                        {
                            <text>Asigne manualmente tickets a los técnicos disponibles</text>
                        }
                    </p>
                </div>
                <a asp-controller="Ticketes" asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver a Tickets
                </a>
            </div>
        </div>
    </div>

    <!-- MENSAJES -->
    @if (ViewBag.SuccessMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @ViewBag.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!ticketsPendientes.Any())
    {
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-inbox fs-1"></i>
            <h4 class="mt-3">No hay tickets pendientes de asignación</h4>
            <p class="text-muted">Todos los tickets han sido asignados</p>
            <a asp-controller="Ticketes" asp-action="Index" class="btn btn-primary mt-2">
                <i class="bi bi-arrow-left"></i> Volver a Tickets
            </a>
        </div>
    }
    else if (!tecnicosDisponibles.Any())
    {
        <div class="alert alert-warning text-center py-5">
            <i class="bi bi-exclamation-triangle fs-1"></i>
            <h4 class="mt-3">No hay técnicos disponibles</h4>
            <p class="text-muted">No se encontraron técnicos en el sistema</p>
        </div>
    }
    else
    {
        <div class="row">
            <!-- COLUMNA IZQUIERDA: TICKETS -->
            <div class="col-lg-5 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-ticket-detailed"></i>
                            @if (esTicketEspecifico)
                            {
                                <text>Ticket a Asignar</text>
                            }
                            else
                            {
                                <text>Tickets Pendientes (@ticketsPendientes.Count)</text>
                            }
                        </h5>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 600px;">
                        @foreach (var ticket in ticketsPendientes)
                        {
                            <div class="card mb-3 ticket-selectable border-@ticket.ColorUrgencia"
                                 data-ticket-id="@ticket.IdTicket"
                                 style="cursor: pointer;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0 fw-bold">
                                            <i class="bi bi-ticket"></i> Ticket #@ticket.IdTicket
                                        </h6>
                                        <span class="badge bg-@ticket.ColorUrgencia">
                                            @ticket.Prioridad
                                        </span>
                                    </div>

                                    <h6 class="mb-2">@ticket.Titulo</h6>
                                    <p class="small text-muted mb-2">@ticket.Descripcion</p>

                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <small class="text-muted">
                                                <i class="bi bi-tag"></i> @ticket.Categoria
                                            </small>
                                        </div>
                                        <div class="col-6 text-end">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar"></i> @ticket.FechaCreacion.ToString("dd/MM/yyyy")
                                            </small>
                                        </div>
                                    </div>

                                    @if (ticket.HorasRestantes.HasValue)
                                    {
                                        <div class="alert alert-@ticket.ColorUrgencia py-1 px-2 mb-0">
                                            <small>
                                                <i class="bi bi-clock-fill"></i>
                                                <strong>@ticket.HorasRestantes horas restantes</strong> para resolución
                                            </small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: TÉCNICOS -->
            <div class="col-lg-7 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-people-fill"></i> Técnicos Disponibles (@tecnicosDisponibles.Count)
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- FORMULARIO DE ASIGNACIÓN -->
                        <form asp-action="AsignarTicketManualmente" method="post" id="formAsignacion">
                            @Html.AntiForgeryToken()

                            <input type="hidden" id="idTicketSeleccionado" name="idTicket" value="@(esTicketEspecifico? ticketId : 0)" />

                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-ticket"></i> Ticket Seleccionado
                                </label>
                                <div class="alert alert-info py-2" id="ticketSeleccionadoInfo">
                                    @if (esTicketEspecifico && ticketsPendientes.Any())
                                    {
                                        <strong>Ticket #@ticketsPendientes.First().IdTicket:</strong> 
                                        @ticketsPendientes.First().Titulo
                                    }
                                    else
                                    {
                                        <em>Haga clic en un ticket de la lista para seleccionarlo</em>
                                    }
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="idTecnico" class="form-label fw-bold">
                                    <i class="bi bi-person-check"></i> Técnico Asignado <span class="text-danger">*</span>
                                </label>
                                <select id="idTecnico" name="idTecnico" class="form-select" required>
                                    <option value="">-- Seleccione un técnico --</option>
                                    @foreach (var tecnico in tecnicosDisponibles.OrderBy(t => t.TicketsActivos))
                                    {
                                        <option value="@tecnico.IdTecnico"
                                                data-carga="@tecnico.TicketsActivos"
                                                data-nombre="@tecnico.NombreTecnico">
                                            @tecnico.NombreTecnico - @tecnico.TicketsActivos tickets activos (@tecnico.NivelCarga)
                                        </option>
                                    }
                                </select>
                            </div>

                            <!-- INFORMACIÓN DEL TÉCNICO SELECCIONADO -->
                            <div id="infoTecnicoSeleccionado" style="display: none;" class="mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-info-circle"></i> Información del Técnico
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <small class="text-muted">Tickets Activos</small>
                                                <h5 id="tecnicoTicketsActivos" class="mb-0">-</h5>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">Pendientes</small>
                                                <h5 id="tecnicoTicketsPendientes" class="mb-0">-</h5>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted">En Proceso</small>
                                                <h5 id="tecnicoTicketsEnProceso" class="mb-0">-</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="justificacion" class="form-label fw-bold">
                                    <i class="bi bi-chat-left-text"></i> Justificación (Opcional)
                                </label>
                                <textarea id="justificacion"
                                      name="justificacion"
                                      class="form-control"
                                      rows="3"
                                      maxlength="500"
                                      placeholder="Ej: Técnico con experiencia en este tipo de problemas..."></textarea>
                                <small class="text-muted">Máximo 500 caracteres</small>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg" id="btnAsignar" disabled>
                                    <i class="bi bi-person-check-fill"></i> Asignar Ticket al Técnico
                                </button>
                                <a asp-controller="Ticketes" asp-action="Index" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- LISTA DE TÉCNICOS CON DETALLE -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Detalle de Técnicos</h6>
                    </div>
                    <div class="card-body overflow-auto" style="max-height: 400px;">
                        @foreach (var tecnico in tecnicosDisponibles.OrderBy(t => t.TicketsActivos))
                        {
                            <div class="card mb-2 tecnico-card" data-tecnico-id="@tecnico.IdTecnico">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="mb-0">
                                                <i class="bi bi-person-circle"></i> @tecnico.NombreTecnico
                                            </h6>
                                            <small class="text-muted">@tecnico.CorreoTecnico</small>
                                        </div>
                                        <span class="badge bg-@(tecnico.NivelCarga == "Baja" ? "success" : tecnico.NivelCarga == "Media" ? "warning" : "danger")">
                                            Carga: @tecnico.NivelCarga
                                        </span>
                                    </div>

                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted d-block">Activos</small>
                                            <strong>@tecnico.TicketsActivos</strong>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block">Pendientes</small>
                                            <strong class="text-warning">@tecnico.TicketsPendientes</strong>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block">En Proceso</small>
                                            <strong class="text-info">@tecnico.TicketsEnProceso</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const esTicketEspecifico = @(esTicketEspecifico.ToString().ToLower());
            const idTicketEspecifico = @ticketId;
            const btnAsignar = document.getElementById('btnAsignar');
            const selectTecnico = document.getElementById('idTecnico');
            const inputTicket = document.getElementById('idTicketSeleccionado');
            const infoTicket = document.getElementById('ticketSeleccionadoInfo');
            const infoTecnico = document.getElementById('infoTecnicoSeleccionado');

            // Si es ticket específico, habilitar botón si se selecciona técnico
            if (esTicketEspecifico) {
                selectTecnico.addEventListener('change', function() {
                    btnAsignar.disabled = !this.value;
                    mostrarInfoTecnico(this.value);
                });
            } else {
                // Manejo de selección de tickets
                const tickets = document.querySelectorAll('.ticket-selectable');
                tickets.forEach(ticket => {
                    ticket.addEventListener('click', function() {
                        // Remover selección previa
                        tickets.forEach(t => t.classList.remove('border-primary', 'border-3'));

                        // Marcar como seleccionado
                        this.classList.add('border-primary', 'border-3');

                        // Actualizar campo oculto
                        const ticketId = this.dataset.ticketId;
                        inputTicket.value = ticketId;

                        // Actualizar info
                        const titulo = this.querySelector('h6.mb-2').textContent;
                        infoTicket.innerHTML = `<strong>Ticket #${ticketId}:</strong> ${titulo}`;
                        infoTicket.className = 'alert alert-primary py-2';

                        // Habilitar botón si hay técnico seleccionado
                        btnAsignar.disabled = !selectTecnico.value;
                    });
                });

                // Habilitar botón cuando ambos estén seleccionados
                selectTecnico.addEventListener('change', function() {
                    btnAsignar.disabled = !(this.value && inputTicket.value);
                    mostrarInfoTecnico(this.value);
                });
            }

            // Mostrar información del técnico seleccionado
            function mostrarInfoTecnico(idTecnico) {
                if (!idTecnico) {
                    infoTecnico.style.display = 'none';
                    return;
                }

                // Buscar técnico en la lista
                const tecnicoCard = document.querySelector(`.tecnico-card[data-tecnico-id="${idTecnico}"]`);
                if (tecnicoCard) {
                    const activos = tecnicoCard.querySelector('.col-4:nth-child(1) strong').textContent;
                    const pendientes = tecnicoCard.querySelector('.col-4:nth-child(2) strong').textContent;
                    const enProceso = tecnicoCard.querySelector('.col-4:nth-child(3) strong').textContent;

                    document.getElementById('tecnicoTicketsActivos').textContent = activos;
                    document.getElementById('tecnicoTicketsPendientes').textContent = pendientes;
                    document.getElementById('tecnicoTicketsEnProceso').textContent = enProceso;

                    infoTecnico.style.display = 'block';
                }
            }

            // Validación del formulario
            document.getElementById('formAsignacion').addEventListener('submit', function(e) {
                if (!inputTicket.value || !selectTecnico.value) {
                    e.preventDefault();
                    alert('⚠️ Debe seleccionar un ticket y un técnico');
                    return false;
                }
            });
        });
    </script>

    <style>
        .ticket-selectable {
            transition: all 0.3s ease;
        }

            .ticket-selectable:hover {
                transform: translateY(-3px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

        .tecnico-card {
            transition: all 0.2s ease;
        }

            .tecnico-card:hover {
                transform: translateX(5px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
    </style>
}