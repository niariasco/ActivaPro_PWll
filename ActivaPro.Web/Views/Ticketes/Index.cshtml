@model IEnumerable<ActivaPro.Application.DTOs.TicketesDTO>

@{
    ViewData["Title"] = "Tickets";
    var idUsuario = ViewBag.IdUsuario;
    var rolUsuario = ViewBag.RolUsuario ?? "Cliente";
    var nombreUsuario = ViewBag.NombreUsuario ?? "Usuario";
}

<h1 class="mb-4">Gestión de Tickets</h1>

<!-- Información del Usuario Actual -->
<div class="alert alert-info mb-3">
    <strong>Usuario:</strong> @nombreUsuario (ID: @idUsuario) | <strong>Rol:</strong> @rolUsuario
</div>

<!-- Botón Crear Ticket - Solo Clientes -->
@if (rolUsuario == "Cliente")
{
    <p>
        <a class="btn btn-primary mb-3" asp-action="Create">
            <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Ticket
        </a>
    </p>
}

<!-- Filtros -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="🔍 Buscar por título o ID...">
            </div>
            <div class="col-md-3">
                <select id="filterEstado" class="form-select">
                    <option value="">📋 Todos los estados</option>
                    <option value="Pendiente">⏳ Pendiente</option>
                    <option value="En Proceso">⚙️ En Proceso</option>
                    <option value="En Espera">⏸️ En Espera</option>
                    <option value="Resuelto">✅ Resuelto</option>
                    <option value="Cerrado">🔒 Cerrado</option>
                    <option value="Cancelado">❌ Cancelado</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="filterAsignacion" class="form-select">
                    <option value="">👥 Todas las asignaciones</option>
                    <option value="sin-asignar">🔴 Sin asignar</option>
                    <option value="asignado">✅ Asignados</option>
                </select>
            </div>
            <div class="col-md-2">
                <button id="clearFilters" class="btn btn-outline-secondary w-100">🗑️ Limpiar</button>
            </div>
        </div>
    </div>
</div>

@if (Model != null && Model.Any())
{
    var sinAsignar = Model.Count(t => t.IdUsuarioAsignado == null || string.IsNullOrEmpty(t.NombreAsignado) || t.NombreAsignado == "Sin asignar");

    <div class="alert alert-success">
        <strong>📊 Total de tickets visibles:</strong> @Model.Count()
        @if (sinAsignar > 0)
        {
            <span class="ms-3">
                <span class="badge bg-danger">⚠️ @sinAsignar sin asignar</span>
            </span>
        }
    </div>

    <table class="table table-striped table-bordered table-hover" id="ticketsTable">
        <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Estado</th>
                <th>Categoría</th>
                <th>Fecha Creación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                var sinAsignarRow = item.IdUsuarioAsignado == null || string.IsNullOrEmpty(item.NombreAsignado) || item.NombreAsignado == "Sin asignar";
                <tr data-asignacion="@(sinAsignarRow ? "sin-asignar" : "asignado")">
                    <td class="fw-bold text-primary">#@item.IdTicket</td>
                    <td>
                        <div>
                            <strong>@item.Titulo</strong>
                            <br />
                            <small class="text-muted">
                                👤 Solicitante: @(item.NombreSolicitante ?? "Desconocido")
                                @if (!string.IsNullOrEmpty(item.NombreAsignado) && item.NombreAsignado != "Sin asignar")
                                {
                                    <span> | 🔧 Asignado: @item.NombreAsignado</span>
                                }
                                else
                                {
                                    <span class="text-danger fw-bold"> | ⚠️ SIN ASIGNAR</span>
                                }
                            </small>
                        </div>
                    </td>
                    <td>
                        @if (item.Estado == "Pendiente")
                        {
                            <span class="badge bg-warning text-dark">⏳ Pendiente</span>
                        }
                        else if (item.Estado == "En Proceso")
                        {
                            <span class="badge bg-info">⚙️ En Proceso</span>
                        }
                        else if (item.Estado == "En Espera")
                        {
                            <span class="badge bg-secondary">⏸️ En Espera</span>
                        }
                        else if (item.Estado == "Resuelto")
                        {
                            <span class="badge bg-success">✅ Resuelto</span>
                        }
                        else if (item.Estado == "Cerrado")
                        {
                            <span class="badge bg-dark">🔒 Cerrado</span>
                        }
                        else if (item.Estado == "Cancelado")
                        {
                            <span class="badge bg-danger">❌ Cancelado</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">@item.Estado</span>
                        }
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">
                            @(item.CategoriaNombre ?? "Sin categoría")
                        </span>
                        @if (!string.IsNullOrEmpty(item.SLA_Prioridad))
                        {
                            @if (item.SLA_Prioridad.Contains("Alta"))
                            {
                                <span class="badge bg-danger ms-1">🔴 Alta</span>
                            }
                            else if (item.SLA_Prioridad.Contains("Media"))
                            {
                                <span class="badge bg-warning text-dark ms-1">🟡 Media</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary ms-1">🟢 Baja</span>
                            }
                        }
                    </td>
                    <td>
                        <small>
                            📅 @item.FechaCreacion.ToString("dd/MM/yyyy")<br />
                            🕒 @item.FechaCreacion.ToString("HH:mm")
                        </small>
                    </td>
                    <td>
                        <div class="btn-group" role="group" style="position: relative; z-index: 1;">
                            <!-- Ver Detalles - TODOS pueden ver -->
                            <button type="button"
                                    class="btn btn-info btn-sm btn-ver-detalle"
                                    data-ticket-id="@item.IdTicket"
                                    onclick="window.location.href='/Ticketes/Details/@item.IdTicket'; console.log('🚀 Navegando a ticket #@item.IdTicket');"
                                    title="Ver detalles"
                                    style="cursor: pointer; pointer-events: auto;">
                                <i class="bi bi-eye"></i>
                            </button>

                            <!-- Asignar Técnico - Solo Admin/Coordinador -->
                            @if (rolUsuario == "Administrador" || rolUsuario == "Coordinador")
                            {
                                <a href="@Url.Action("AsignacionManual", "Asignaciones", new { ticketId = item.IdTicket })"
                                   class="btn btn-primary btn-sm"
                                   title="Asignar técnico">
                                    <i class="bi bi-person-plus"></i>
                                </a>
                            }

                            <!-- Editar - Solo Técnico asignado -->
                            @if ((rolUsuario == "Tecnico" || rolUsuario == "Técnico") && item.IdUsuarioAsignado == idUsuario)
                            {
                                <a asp-action="Edit" asp-route-id="@item.IdTicket"
                                   class="btn btn-warning btn-sm" title="Editar ticket">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            }

                            <!-- Cerrar - Cliente (propietario) o Admin -->
                            @if (item.Estado != "Cerrado" && item.Estado != "Cancelado")
                            {
                                @if ((rolUsuario == "Cliente" && item.IdUsuarioSolicitante == idUsuario) || rolUsuario == "Administrador")
                                {
                                    <a asp-action="Close" asp-route-id="@item.IdTicket"
                                       class="btn btn-danger btn-sm"
                                       title="Cerrar ticket"
                                       onclick="return confirm('¿Está seguro de cerrar este ticket?');">
                                        <i class="bi bi-x-circle"></i>
                                    </a>
                                }
                            }
                            else if (item.Estado == "Cerrado")
                            {
                                <span class="badge bg-secondary" title="Ticket cerrado">🔒</span>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-warning text-center py-5">
        <i class="bi bi-inbox fs-1"></i>
        <h4 class="mt-3">No hay tickets disponibles</h4>
        <p class="text-muted">No hay tickets registrados en el sistema.</p>
        @if (rolUsuario == "Cliente")
        {
            <a asp-action="Create" class="btn btn-primary mt-2">
                <i class="bi bi-plus-circle me-2"></i>Crear tu primer ticket
            </a>
        }
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Script de tickets cargado correctamente');

            // ========== FILTROS ==========
            const searchInput = document.getElementById('searchInput');
            const filterEstado = document.getElementById('filterEstado');
            const filterAsignacion = document.getElementById('filterAsignacion');
            const clearFilters = document.getElementById('clearFilters');
            const table = document.getElementById('ticketsTable');

            if (table) {
                const rows = table.querySelectorAll('tbody tr');

                function filterTable() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const selectedEstado = filterEstado.value.toLowerCase();
                    const selectedAsignacion = filterAsignacion.value;

                    rows.forEach(row => {
                        const id = row.cells[0].textContent.toLowerCase();
                        const titulo = row.cells[1].textContent.toLowerCase();
                        const estado = row.cells[2].textContent.toLowerCase();
                        const asignacion = row.dataset.asignacion;

                        const matchesSearch = id.includes(searchTerm) || titulo.includes(searchTerm);
                        const matchesEstado = !selectedEstado || estado.includes(selectedEstado);
                        const matchesAsignacion = !selectedAsignacion || asignacion === selectedAsignacion;

                        if (matchesSearch && matchesEstado && matchesAsignacion) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                }

                searchInput.addEventListener('input', filterTable);
                filterEstado.addEventListener('change', filterTable);
                filterAsignacion.addEventListener('change', filterTable);

                clearFilters.addEventListener('click', function() {
                    searchInput.value = '';
                    filterEstado.value = '';
                    filterAsignacion.value = '';
                    filterTable();
                });
            }

            // ========== DEBUGGING BOTÓN VER DETALLES ==========
            const botonesDetalle = document.querySelectorAll('.btn-ver-detalle');
            console.log(`👁️ Se encontraron ${botonesDetalle.length} botones de ver detalles`);

            botonesDetalle.forEach(function(boton) {
                const ticketId = boton.getAttribute('data-ticket-id');
                const href = boton.getAttribute('href');

                console.log(`✅ Botón para ticket #${ticketId} - URL: ${href}`);

                // Agregar evento de click para debugging CON ALTA PRIORIDAD
                boton.addEventListener('click', function(e) {
                    console.log(`🖱️ Click en ver detalles del ticket #${ticketId}`);
                    console.log(`📍 Navegando a: ${href}`);

                    // FORZAR NAVEGACIÓN - detener cualquier otro evento
                    e.stopPropagation();
                    e.preventDefault();

                    console.log('🚀 Forzando navegación...');
                    window.location.href = href;
                }, true); // true = captura en fase de captura (alta prioridad)
            });

            // Verificar si hay algún event listener que esté bloqueando
            document.addEventListener('click', function(e) {
                const detalleBtn = e.target.closest('.btn-ver-detalle');
                if (detalleBtn) {
                    console.log('🔍 Detectado click en botón de ver detalles (document level)');
                    console.log('🎯 Elemento clickeado:', e.target);
                    console.log('🔗 Elemento del enlace:', detalleBtn);
                    console.log('🧪 Computed style del botón:', window.getComputedStyle(detalleBtn).pointerEvents);
                }
            }, true);

            // Detectar TODOS los clicks en la página para ver si llegan
            document.addEventListener('click', function(e) {
                console.log('📍 Click detectado en:', e.target);
            }, true);
        });
    </script>
}