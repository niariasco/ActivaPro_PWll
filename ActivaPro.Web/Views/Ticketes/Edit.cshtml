@model ActivaPro.Application.DTOs.TicketEditDTO

@{
    ViewData["Title"] = $"Editar Ticket #{Model.IdTicket}";
    var rolUsuario = ViewBag.RolUsuario as string ?? "Cliente";
    var idUsuarioActual = ViewBag.IdUsuarioActual ?? 0;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil"></i> Editar Ticket #@Model.IdTicket
                    </h4>
                    <small class="text-muted">
                        <i class="bi bi-person-badge"></i> Usuario: @rolUsuario (ID: @idUsuarioActual)
                    </small>
                </div>
                <div class="card-body">
                    <!-- Mensajes -->
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-circle"></i> @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-action="Edit" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="IdTicket" />
                        <input type="hidden" asp-for="IdUsuarioSolicitante" />
                        <input type="hidden" asp-for="IdCategoria" />
                        <input type="hidden" asp-for="IdSLA" />
                        <input type="hidden" asp-for="FechaCreacion" />
                        <input type="hidden" asp-for="FechaLimiteResolucion" />

                        <!-- INFORMACIÓN DEL SOLICITANTE -->
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="bi bi-person"></i> Información del Solicitante (No editable)
                                </h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Nombre:</strong> @Model.NombreSolicitante
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Correo:</strong> @Model.CorreoSolicitante
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Creado:</strong> @Model.FechaCreacion.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TÍTULO -->
                        <div class="mb-3">
                            <label asp-for="Titulo" class="form-label fw-bold">
                                Título <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Titulo"
                                   class="form-control"
                                   maxlength="150"
                                   placeholder="Ingrese el título del ticket" />
                            <span asp-validation-for="Titulo" class="text-danger"></span>
                        </div>

                        <!-- DESCRIPCIÓN -->
                        <div class="mb-3">
                            <label asp-for="Descripcion" class="form-label fw-bold">
                                Descripción <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="Descripcion"
                                      class="form-control"
                                      rows="5"
                                      maxlength="2000"
                                      placeholder="Describa el problema o solicitud"></textarea>
                            <span asp-validation-for="Descripcion" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <!-- ESTADO -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Estado" class="form-label fw-bold">
                                        Estado <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="Estado" class="form-select">
                                        @foreach (var estado in Model.EstadosDisponibles)
                                        {
                                            <option value="@estado">@estado</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Estado" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- USUARIO ASIGNADO (Solo para Administrador y Técnico) -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="IdUsuarioAsignado" class="form-label fw-bold">
                                        Asignado a
                                    </label>
                                    @if (rolUsuario == "Administrador")
                                    {
                                        <select asp-for="IdUsuarioAsignado" class="form-select">
                                            <option value="">-- Sin asignar --</option>
                                            @if (Model.IdUsuarioAsignado.HasValue)
                                            {
                                                <option value="@Model.IdUsuarioAsignado" selected>@Model.NombreUsuarioAsignado</option>
                                            }
                                        </select>
                                    }
                                    else
                                    {
                                        <input type="text" class="form-control" value="@Model.NombreUsuarioAsignado" readonly />
                                        <input type="hidden" asp-for="IdUsuarioAsignado" />
                                    }
                                    <small class="form-text text-muted">
                                        Actualmente: @Model.NombreUsuarioAsignado
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- CATEGORÍA Y SLA -->
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-muted">
                                    <i class="bi bi-info-circle"></i> Categorización (No editable)
                                </h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Categoría:</strong> @Model.CategoriaNombre
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Prioridad:</strong>
                                        @if (Model.SLA_Prioridad?.Contains("Alta") == true)
                                        {
                                            <span class="badge bg-danger"> Alta</span>
                                        }
                                        else if (Model.SLA_Prioridad?.Contains("Media") == true)
                                        {
                                            <span class="badge bg-warning text-dark">🟡 Media</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">🟢 Baja</span>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <strong>SLA:</strong> @Model.SLA_Descripcion
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- GESTIÓN DE IMÁGENES -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-images"></i> Gestión de Imágenes</h6>
                            </div>
                            <div class="card-body">
                                <!-- IMÁGENES EXISTENTES -->
                                @if (Model.ImagenesExistentes != null && Model.ImagenesExistentes.Any())
                                {
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Imágenes Actuales</label>
                                        <div class="row mt-2">
                                            @foreach (var imagen in Model.ImagenesExistentes)
                                            {
                                                <div class="col-md-3 col-sm-4 col-6 mb-3">
                                                    <div class="position-relative">
                                                        <img src="@imagen.RutaArchivo"
                                                             class="img-thumbnail"
                                                             alt="@imagen.NombreArchivo"
                                                             style="width: 100%; height: 150px; object-fit: cover;" />
                                                        <div class="form-check position-absolute bg-white bg-opacity-75 p-2 rounded"
                                                             style="top: 5px; left: 5px;">
                                                            <input type="checkbox"
                                                                   class="form-check-input"
                                                                   name="ImagenesAEliminar"
                                                                   value="@imagen.IdImagen"
                                                                   id="eliminar_@imagen.IdImagen" />
                                                            <label class="form-check-label" for="eliminar_@imagen.IdImagen">
                                                                <small>Eliminar</small>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <small class="d-block text-muted text-center mt-1">
                                                        @imagen.NombreArchivo
                                                    </small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted"> No hay imágenes adjuntas</p>
                                }

                                <!-- AGREGAR NUEVAS IMÁGENES -->
                                <div class="mb-3">
                                    <label for="NuevasImagenes" class="form-label fw-bold">
                                        <i class="bi bi-plus-circle"></i> Agregar Nuevas Imágenes
                                    </label>
                                    <input type="file"
                                           name="NuevasImagenes"
                                           id="NuevasImagenes"
                                           class="form-control"
                                           accept=".jpg,.jpeg,.png,.gif,.bmp"
                                           multiple
                                           onchange="mostrarNuevasImagenes(this)" />
                                    <span asp-validation-for="NuevasImagenes" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <i class="bi bi-info-circle"></i>
                                        Máximo 5 imágenes en total. Formatos: JPG, PNG, GIF, BMP. Tamaño máximo: 5MB por imagen
                                    </small>

                                    <!-- Previsualización -->
                                    <div id="previsualizacionNuevas" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES -->
                        <div class="d-flex justify-content-center gap-3 mt-4">
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="bi bi-save"></i> Guardar Cambios
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.IdTicket" class="btn btn-secondary btn-lg px-5">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function mostrarNuevasImagenes(input) {
            const previsualizacion = document.getElementById('previsualizacionNuevas');
            previsualizacion.innerHTML = '';

            if (input.files && input.files.length > 0) {
                Array.from(input.files).forEach((file) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'd-inline-block me-2 mb-2 position-relative';
                        div.innerHTML = `
                            <img src="${e.target.result}"
                                 class="img-thumbnail"
                                 style="width: 100px; height: 100px; object-fit: cover;"
                                 title="${file.name}">
                            <span class="badge bg-success position-absolute"
                                  style="top: 5px; right: 5px; font-size: 0.7rem;">
                                ${(file.size / 1024).toFixed(0)} KB
                            </span>
                        `;
                        previsualizacion.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }
    </script>
}